import PIconnect as PI
from datetime import datetime, timedelta
import pandas as pd

# 连接到 PI 服务器
servername = "grape"  # 替换为你的 PI 服务器名称
with PI.PIServer(server=servername) as server:
    # 搜索你感兴趣的 Tag
    tag = server.search('your_tag')[0]  # 替换 'your_tag' 为实际的 PI Tag 名称

    # 定义时间范围
    start_time = datetime(2024, 1, 1)
    end_time = datetime(2024, 1, 2)
    
    # 定义插值间隔
    interval = timedelta(minutes=15)  # 插值每 15 分钟
    
    # 获取插值数据
    data = tag.interpolated_values(
        start_time=start_time,
        end_time=end_time,
        interval=interval
    )

    # 将数据转换为 pandas DataFrame
    df = pd.DataFrame(data).reset_index()
    df.columns = ['Timestamp', 'Value']

    # 计算时间加权平均值
    time_deltas = (df['Timestamp'] - df['Timestamp'].shift(1)).dt.total_seconds().fillna(0)
    weighted_values = df['Value'] * time_deltas
    time_weighted_average = weighted_values.sum() / time_deltas.sum()

    # 打印结果
    print(f"{tag.name} 从 {start_time} 到 {end_time} 的时间加权平均值: {time_weighted_average}")
