@app.callback(  # 此 PPD query data 為最後 performance data 畫圖用
    Output("filtered-data-melting", "data"),
    Output("filtered-data-finishing", "data"),
    Input("date-picker", "value"),
    Input("tank-picker", "value"),
    Input("gen-picker", "value"),
    Input("thickness-picker", "value"),
    Input("line-picker", "value"),
)
def query_data(date_range, tank, gen, thickness, line): 
    if not date_range or not tank:
        raise PreventUpdate  

    start_date, end_date = map(pd.to_datetime, date_range)

    # 查詢 Melting Loss
    query_m = f"""
        SELECT 
            NON EMPTY {{ [Measures].[M_Defect Loss%] }} ON COLUMNS, 
            NON EMPTY {{ ([Time Crate].[CR_Time YQMD].[CR_Date].ALLMEMBERS * 
                            [Finishing Source Tank].[Source Tank ID].ALLMEMBERS * 
                            [Defect Tracking].[Defect ID].[Defect ID].ALLMEMBERS) }} 
            DIMENSION PROPERTIES MEMBER_CAPTION, MEMBER_UNIQUE_NAME 
        ON ROWS 
        FROM ( 
            SELECT 
                {{ [Finishing Source Tank].[Source Tank ID].&[{tank}] }} ON COLUMNS 
            FROM ( 
                SELECT 
                    {{ [Time Crate].[CR_Date].&[{start_date.strftime("%Y-%m-%dT00:00:00")}] : 
                        [Time Crate].[CR_Date].&[{end_date.strftime("%Y-%m-%dT00:00:00")}] }} ON COLUMNS 
                FROM [PPD_Actual]
            ) 
        ) 
        WHERE ( 
            [Production Type].[Production Type Hierarchy].[Lot Type／Scheduled].&[M-Scheduled], 
            [Production Type].[Production Type Hierarchy].[SubType].&[F-Engineering] 
        ) 
        CELL PROPERTIES VALUE, BACK_COLOR, FORE_COLOR, FORMATTED_VALUE, FORMAT_STRING, FONT_NAME, FONT_SIZE, FONT_FLAGS
    """

    # 設置 Finishing Loss 的篩選條件
    gen_condition = ", ".join ([f"[FG Product].[FG_Gen].&[{gen}]" for gen in gen ])if gen else ""
    thickness_condition =", ".join ([f"[FG Product].[FG_Thickness].&[{thickness}]" for thickness in thickness ])if thickness else ""
    line_condition =", ".join ([f"[Finishing Line].[Line ID].&[{line}]" for line in line ])if line else ""

    # 查詢 Finishing Loss
    query_f = f"""
        SELECT 
            NON EMPTY {{ [Measures].[F_Defect Loss%] }} ON COLUMNS, 
            NON EMPTY {{ ([Time Crate].[CR_Time YQMD].[CR_Date].ALLMEMBERS * 
                            [Finishing Source Tank].[Source Tank ID].ALLMEMBERS * 
                            [Defect Tracking].[Defect ID].[Defect ID].ALLMEMBERS) }} 
            DIMENSION PROPERTIES MEMBER_CAPTION, MEMBER_UNIQUE_NAME 
        ON ROWS 
        FROM ( 
            SELECT 
                {{ [Finishing Source Tank].[Source Tank ID].&[{tank}] }} ON COLUMNS 
            FROM ( 
                SELECT 
                    {{ [Time Crate].[CR_Date].&[{start_date.strftime("%Y-%m-%dT00:00:00")}] : 
                        [Time Crate].[CR_Date].&[{end_date.strftime("%Y-%m-%dT00:00:00")}] }} ON COLUMNS 
                FROM [PPD_Actual]
            ) 
        ) 
        WHERE ( 
            [Production Type].[Production Type Hierarchy].[Lot Type／Scheduled].&[F-Normal], 
            [Production Type].[Production Type Hierarchy].[SubType].&[F-Div], 
            [Production Type].[Production Type Hierarchy].[SubType].&[F-Engineering], 
            [Production Type].[Production Type Hierarchy].[SubType].&[F-Plant],
            {f"{{{gen_condition}}}" if gen_condition else ""},
            {f"{{{thickness_condition}}}" if thickness_condition else ""},
            {f"{{{line_condition}}}" if line_condition else ""}
        ) 
        CELL PROPERTIES VALUE, BACK_COLOR, FORE_COLOR, FORMATTED_VALUE, FORMAT_STRING, FONT_NAME, FONT_SIZE, FONT_FLAGS
    """

    print('M = ', get_PPD(query_m))
    print('F = ', get_PPD(query_f))
    
    try:
        # 數據清理
        df_cleaned_M = clean_data(get_PPD(query_m))
        df_cleaned_F = clean_data(get_PPD(query_f))
        # 將數據轉成字典返回
        return df_cleaned_M.to_dict("records"), df_cleaned_F.to_dict("records")
        
    except Exception as e:
        print("Error occurred during query execution:")
        print(e)
        return [], []
